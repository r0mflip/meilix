# This provides us with GCC binary support so we can run bash
language: generic

# Try to supply the packages from Travis so that when we run build.sh we won't
# be required to download them again.
include:
  - os: linux
    addons:
      apt:
        update: true
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - debootstrap
          - genisoimage
          - p7zip-full
          - squashfs-tools
          - ubuntu-dev-tools
          - dpkg-dev
          - debhelper
          - fakeroot
          - devscripts

sudo: required

git:
  depth: 22

script:
  - export LC_ALL=en_US.UTF-8
  - export LANG=en_US.UTF-8
  - export LANGUAGE=en_US.UTF-8
  - chmod +x ./build.sh
  - ./build.sh |& tee log.txt

before_deploy:
  - export image_name="`echo *.iso`"
  - cat *.iso > "/home/travis/${image_name}"


deploy:
  - provider: releases
    skip_cleanup: true
    api_key:
      secure: "CMse0wxEcLKcI+hAsaraVoDqolX6Jkpioo9CcwgyuXB8vZ1CYyUbmDEB0vMvZuddPkp2TokF3EK+aRJcId9zR7rk81OGpA2C1+meLzPbla3JNWRO+cyLduallLXFusBFZ7G8og0blBqseNCZvSevQy84gLpIgs23Esk9TvZO601yUudv4NmN6893KUmPCLgEQv0Pl97qjuKiFjecD0X5LWGPz9ClkcQTS7rHVYgul6DUjfZmc13RbTpU8bwAEHAXoIpu8Ko86Ie/1H+5wQYvycjW3qBsD300BQWudoWLQm73clTy3uLl6aFpIdzHMtsmisYrT8/o7y7EyM7n+5w00NVCafQyulzEQNQ/lR+GvaEo0RQsvQnsUoaIvDeqsuCwuej1UPiLZA3RqAb7bJ/LZ/R7w0TJxJU3RfUOrQ/vn42AQDiy1OjmYsr/VHGRuBS9Cv2NF9+rGDrTQtz+zQMlU2PHAcmioWsjrH9CHcZT2E4/lQPRcRyG/5ljI2Dx0o/iZl1eDkLWI3i6jBYR7UA3Jjk74oM551njDib/yhsZNxEoVRg6aiEPstueE5F/mnYWF5pprnVcjPd13CESH9HwrUVmg7o/VrlYuQn+RFPI1BA0nhX+koesKeQVX2PBNYFE//82mDIF0ZE/O+lSUoSWHKX8lDxtJVl1rYj044J3CKM=VVKOMh0dZCrHkAfoqIYJYleJwTwXptumugYVcGi/WDaeFi9o1ROTKVdLXUO2CcAUgWUphWjnckF4uVdKBcCB87Af0hgQBXdpDJ4VSb2FFjjY3Lf5dpR1FTYR6Tqsn821mYM17wtwmO1tlg8zFqd1yysr36wZ0EqzFwBtV2FA0jNfxGtFyyJRZnDcCQqwREc2iIENSt8tE787HbwPaWGBEkpC8zYwNYkQXPgFvTi+Z/6Tnobz7gnk9wQFuzFDymr6sDTQF+2ycfGnJnXDOZjqC5haDZbXop6dR/ru6hwO6U4khQIFHEPMZEEHnocB1gOOSiM9Z/yztmY18X4jzx8gZAMIrdKwYlZzEeVAbnlX0WXfjOFmcKIvaMtdNZg9QJil3ePPq/80uNo4TGUy+04ll6jBqqMf4BTs/dxohLyksxN79iuAplRtEl96ZQG+0VI1B0OE3WjwtcuvcuTW7oZ1sOULY4UsNmIdPpJZqIrQpN4AevRJ6DV844uvJ63Sbdzyu0EjMTp+h+2dWiQnnW4aP0mbYsBGWTj0vM2CD/fHtM9W6oVNqLsF7pEe9fg7d2hYJS7Zkuwco33WHqy4JGvLl9uyzSsy0cueJgwg5DYJ8zWDzhlCbKtEk1kG+eKVj+C5rG4shOMK4zf+0iVn5BCNB5d3OgLpAGJwFx1uqqTMrc="
    file_glob: true # http://stackoverflow.com/a/28579635/1320237
    file: "/home/travis/${image_name}"
    on:
      all_branches: true

after_deploy:
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then bash ./scripts/releases_maintainer.sh; fi'
  - cd scripts && ./mail.py
  
after_failure:
  - cd scripts && ./mail-fail.py
