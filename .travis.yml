# This provides us with GCC binary support so we can run bash
language: generic

# Try to supply the packages from Travis so that when we run build.sh we won't
# be required to download them again.
include:
  - os: linux
    addons:
      apt:
        update: true
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - debootstrap
          - genisoimage
          - p7zip-full
          - squashfs-tools
          - ubuntu-dev-tools
          - dpkg-dev
          - debhelper
          - fakeroot
          - devscripts

sudo: required

git:
  depth: 22

script:
  - export LC_ALL=en_US.UTF-8
  - export LANG=en_US.UTF-8
  - export LANGUAGE=en_US.UTF-8
  - chmod +x ./build.sh
  - ./build.sh |& tee log.txt

before_deploy:
  - export image_name="`echo *.iso`"
  - cat *.iso > "/home/travis/${image_name}"


deploy:
  - provider: releases
    skip_cleanup: true
    api_key:
      secure: "GlaZi5I5lUtXomNRPhzfG4MdEqaiGzgYzrkVdJQ16uarZ9i5D8X5vtFAwKMgDPLSvk66M+sMtrrtVwB/Gp/zJVNVKpvQbU6DGMvCsd11jRp6rsKyuS0QhA4yVj8+x4gSi2jwps2B1jNib3+7nkYNAx8QA5oBTCAzIgypkmghUz/b4h51k+ddV0Ki/GEH336qnFvXuLR7YFb24D1ZMBUZ5jqBXrAq6txZiE/7uLY3Wyah7cZR/b5YsUj9hpXCdv4btWkBpu7J7BLtQKTkqlGeAwtX2fguAGRoe6MzDU5X16RKlnqAbAjJiNvp5RC0RcSPBq+nEkSMABrAiyzNKFuHPBqkdLFopN1Iuug7KvgQTr9OAsrNh/fnhrpEjKqYTwFJ+kpYxxkuzfoXmMnxckLH3Dd58HNgN5inaKPRsBuJ7DgS5Cunes+1udjD6OKwCPbzjwUea9jFV8a9ETTOpbM7qRssyp+6nyPQ7fPpzc8Wob4rF3VR+XR5x/aSqLRm52YSL44IbNWs7ijJXVvsGWg5WI/1YlkxTVzdQDYFbQt2VyN7buJ/3en2MBGPEm6RMY2Ih7nd7BuUIeUkstNoyKMP1KJGHa2vuGUdTRYZJqVp3i3dIBzBa7qQjp8k34fOX2bQ6htZvoggTTGJi5m1QEnQku8UC32aC0Ela2fSUriHMig="
    file_glob: true # http://stackoverflow.com/a/28579635/1320237
    file: "/home/travis/${image_name}"
    on:
      all_branches: true

after_deploy:
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then bash ./scripts/releases_maintainer.sh; fi'
  - cd scripts && ./mail.py
  
after_failure:
  - cd scripts && ./mail-fail.py
